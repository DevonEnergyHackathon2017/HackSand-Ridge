var SD=SD||{};SD.DataWorker=function(){};SD.DataWorker.prototype=function(){var h,i={},f=[],c=!0,n={ONLINE:1,TIMEDOUT:2,OFFLINE:3,REVALIDATE:4},a=function(n){n!=undefined&&(c=n)},v=function(t){return t==n.ONLINE},y=function(t){return t==n.TIMEDOUT},p=function(t){return t==n.OFFLINE},w=function(t){return t==n.REVALIDATE},b=function(t){c?u({url:i.url,timeout:i.timeout,success:function(){i.validationURL?u({url:i.validationURL,timeout:i.timeout,success:function(){t(n.ONLINE)},error:function(i){i&&i.message&&i.message=="timeout"?t(n.TIMEDOUT):t(n.REVALIDATE)}}):t(n.ONLINE)},error:function(i){i&&i.message&&i.message=="timeout"?t(n.TIMEDOUT):t(n.OFFLINE)}}):t(n.OFFLINE)},k=function(n){n.returnArr!=undefined&&n.returnArr?nt(n):tt(n)},d=function(n){n.data&&n.data!=null?it(n):rt(n)},g=function(n){n.shim&&importScripts("indexeddbshim.js");var t=indexedDB.open(n.dbName);t.onsuccess=function(){h=this.result;l(n);n.success()};t.onerror=function(){n.error(this.error)}},l=function(n){i.url=n.onlineURL;i.validationURL=n.validationURL;i.timeout=n.onlineTimeout?n.onlineTimeout:5e3;f=n.dbTables},nt=function(n){var t=o(n.table);u({url:t.url,data:n.data?n.data:null,success:function(t){var i=t.responseText;i&&(i=JSON.parse(i));i&&i.Message?n.callback({callbackID:n.callbackID,err:"handler error (Get) -- "+i.Message,responseData:t}):n.callback({callbackID:n.callbackID,dataArr:i,responseData:t})},error:function(t){n.callback({callbackID:n.callbackID,err:"AJAX error (Get)"+(t.message?" -- "+t.message:""),responseData:t})}})},tt=function(n){var t=o(n.table);u({url:t.url,data:n.data?n.data:null,success:function(i){var r=i.responseText;r&&(r=JSON.parse(r));r&&r.Message?n.callback({callbackID:n.callbackID,err:"handler error (Get) -- "+r.Message,responseData:i}):ft({tableName:t.name,success:function(){et({tableName:t.name,data:r});n.callback({callbackID:n.callbackID,responseData:i})},error:function(t){n.callback({callbackID:n.callbackID,err:"ClearTable error (Get) "+t})}})},error:function(t){n.callback({callbackID:n.callbackID,err:"AJAX error (Get)"+(t.message?" -- "+t.message:""),responseData:t})}})},it=function(n){var t=o(n.table);u({url:t.url,contentType:"application/json",type:"POST",data:JSON.stringify(n.data),success:function(t){var r=[],i=t.responseText;i&&(i=JSON.parse(i));i&&i.Message&&r.push({err:"handler error (Post) -- "+i.Message});n.callback({callbackID:n.callbackID,err:r,responseData:t})},error:function(t){n.callback({callbackID:n.callbackID,err:[{err:"AJAX error (Post)"+(t.message?" -- "+t.message:"")}],responseData:t})}})},rt=function(n){var t=[],i=o(n.table);ot({tableName:i.name,success:function(r){for(item in r)u({url:i.url,contentType:"application/json",type:"POST",data:JSON.stringify(r[item].value),success:function(n){var u=n.responseText;u&&(u=JSON.parse(u));u&&u.Message?t.push({err:"handler error (Post) -- "+u.Message}):st({tableName:i.name,key:r[item].key})},error:function(){t.push({err:"AJAX error (Post) -- "+e})}});n.callback({callbackID:n.callbackID,err:t,responseData:response})},error:function(t){n.callback({callbackID:n.callbackID,err:[{err:t.message?t.message:""}],responseData:t})}})},o=function(n){for(t in f)if(f[t].name==n)return f[t]},u=function(n){var i=n.timeout?n.timeout:0,u=n.url+(n.cache&&n.cache==!0?"":(n.url.indexOf("?")>0?"&":"?")+"_="+(new Date).getTime()),t=new XMLHttpRequest;t.open(n.type?n.type:"GET",u,i>0?!0:!1);n.contentType&&t.setRequestHeader("Content-Type",n.contentType);i>0?(t.timeout=i,t.ontimeout=function(){n.error&&n.error(r(t,"timeout"))},t.onerror=function(){n.error&&n.error(r(t))},t.onload=function(){t.readyState===4&&t.status===200?n.success&&n.success(r(t)):n.error&&n.error(r(t,"Invalid return"))},t.onabort=function(){n.error&&n.error(r(t,"XHR aborted"))},t.send(n.data?n.data:null)):(t.send(n.data?n.data:null),t.status===200?n.success&&n.success(r(t)):n.error&&n.error(r(t)))},r=function(n,t){return n?{readyState:n.readyState,responseHeaders:ut(n.getAllResponseHeaders()),responseText:n.responseText,status:n.status,statusText:n.statusText,message:t?t:null}:t?{message:t?t:null}:null},ut=function(n){var t,u,i,r;if(n){if(t=n.toLowerCase().split("\r\n"),t&&t.length>0){for(u=[],i=[],r=0;r<t.length;r++)t[r].indexOf(": ")>0&&(i=t[r].split(": "),i&&i.length===2&&u.push({name:i[0],value:i[1]}));return u}return[]}return[]},s=function(n){return h.transaction(n,"readwrite").objectStore(n)},ft=function(n){var t=s(n.tableName).clear();t.onsuccess=function(){n.success()};t.onerror=function(){n.error(this.error)}},et=function(n){var t=s(n.tableName);for(item in n.data)t.add(n.data[item])},ot=function(n){var t=[];s(n.tableName).openCursor().onsuccess=function(i){var r=i.target.result;r?(t.push({key:r.key,value:r.value}),r.continue()):n.success(t)}},st=function(n){var t=s(n.tableName).delete(n.key)};return{SetOnline:a,IsOnline:v,IsTimedOut:y,IsOffline:p,Revalidate:w,CheckServerConnection:b,Get:k,Post:d,OpenDB:g,Init:l}}();